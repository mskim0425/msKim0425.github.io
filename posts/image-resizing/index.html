<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Marvin 라이브러리를 활용한 S3에 리사이징된 이미지 업로드" /><meta property="og:locale" content="en" /><meta name="description" content="이미지 리사이징을 하게 된 계기" /><meta property="og:description" content="이미지 리사이징을 하게 된 계기" /><link rel="canonical" href="https://mskim0425.github.io/posts/image-resizing/" /><meta property="og:url" content="https://mskim0425.github.io/posts/image-resizing/" /><meta property="og:site_name" content="SoThoughtful;" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-20T13:11:04+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Marvin 라이브러리를 활용한 S3에 리사이징된 이미지 업로드" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="jbF7fLQfFijq2Mi-8IkGRoUPQhLTlkTskBtbAoEmH4o" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-05T22:58:08+09:00","datePublished":"2023-01-20T13:11:04+09:00","description":"이미지 리사이징을 하게 된 계기","headline":"Marvin 라이브러리를 활용한 S3에 리사이징된 이미지 업로드","mainEntityOfPage":{"@type":"WebPage","@id":"https://mskim0425.github.io/posts/image-resizing/"},"url":"https://mskim0425.github.io/posts/image-resizing/"}</script><title>Marvin 라이브러리를 활용한 S3에 리사이징된 이미지 업로드 | SoThoughtful;</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="SoThoughtful;"><meta name="application-name" content="SoThoughtful;"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/107451298?s=400&u=e5165c561ac67ec7819798bbd37382f3630f4a99&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">SoThoughtful;</a></div><div class="site-subtitle font-italic">백엔드 개발자</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>REFERENCE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/msKim0425" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mins402kim','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/%EB%AF%BC%EC%84%AD-%EA%B9%80-610901191/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Marvin 라이브러리를 활용한 S3에 리사이징된 이미지 업로드</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Marvin 라이브러리를 활용한 S3에 리사이징된 이미지 업로드</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1674187864" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 20, 2023 </em> </span> <span> Updated <em class="" data-ts="1680703088" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 5, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/msKim0425">Minsub Kim</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1628 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h1 id="이미지-리사이징을-하게-된-계기">이미지 리사이징을 하게 된 계기</h1><p>S3 프리티어 저장공간의 수용량이 90%가 넘으면서 이미지에 대한 용량관리를 해야할 필요성을 느꼈다. <br /> 초고화질 이미지가 우리의 서비스에서는 굳이 원본상태로 보일 필요성을 못느꼈다. 400px*300px 정도의 이미지면 충분한 서비스에 배경화면 2450x1440 사이즈를 그대로 저장할 필요가 없었다.</p><h2 id="1-해결과정-3mb-이상-이미지를-허용하지않는다"><span class="mr-2">#1 해결과정 3mb 이상 이미지를 허용하지않는다.</span><a href="#1-해결과정-3mb-이상-이미지를-허용하지않는다" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>단순하게 용량을 제한 하는것 만으로도 무지막지한 용량의 이미지를 차단할 수 있는 장점이 있었다.<br /> 또한, java.awt.Graphics2D, Imgscalr, Marvin 등 이미지 리사이징 라이브러리 사용 시 ,이미지IO와 변환과정에서 3mb이상의 이미지는 리사이징하는데 상당히 오랜 시간이 소요된다.<br /> 따라서, 아래와 같이 multipart 사이즈에 제약 조건을 application.yml파일에 설정하였다.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="na">spring</span><span class="pi">:</span>
  <span class="na">servlet</span><span class="pi">:</span>
    <span class="na">multipart</span><span class="pi">:</span>
      <span class="na">max-file-size</span><span class="pi">:</span> <span class="s">3MB</span>
      <span class="na">max-request-size</span><span class="pi">:</span> <span class="s">3MB</span>
</pre></table></code></div></div><h2 id="2-해결과정--aws-lambda"><span class="mr-2">#2 해결과정 AWS LAMBDA</span><a href="#2-해결과정--aws-lambda" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>앞서 언급한 3mb이상의 이미지 IO 발생 시, 제약없이 빠르게 업로드 후 리사이징 할 수 있는 방법이 있었다. CloudFront와 AWS LAMBDA를 사용하여 <code class="language-plaintext highlighter-rouge">온디멘드 방식의 리사이징</code>을 하는 것이다. <br /> Serverless인 람다에서 이미지를 리사이징하는 방법은 저장된 큰 이미지의 용량을 줄이고 좀 더 빠른 업로드를 하는 이점은 있었으나, <code class="language-plaintext highlighter-rouge">하나의 이미지가 원본 S3공간과 리사이징된 S3공간 두 곳으로 저장</code>되어 관리포인트가 더 늘어났고 그 결과 용량절감의 효과가 떨어졌다.쇼핑몰처럼 원본이미지가 필요한 서비스가 아니기에 이 방법을 선택하지 않았다.</p><h2 id="3-해결과정-marvin-라이브러리-사용"><span class="mr-2">#3 해결과정 Marvin 라이브러리 사용</span><a href="#3-해결과정-marvin-라이브러리-사용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="javaawtgraphics2d-라이브러리"><span class="mr-2">java.awt.Graphics2D 라이브러리</span><a href="#javaawtgraphics2d-라이브러리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>처음엔 Graphics2D를 이용해서 구현하였으나, 이미지가 점묘화되는 현상으로 다른 방안을 찾아야했다. <img data-src="https://github.com/mskim0425/mskim0425.github.io/blob/main/images/java/Graphics2D.png?raw=https://raw.githubusercontent.com/cotes2020/chirpy-images/maintrue" width="800" data-proofer-ignore></p><h3 id="marvin-라이브러리"><span class="mr-2">Marvin 라이브러리</span><a href="#marvin-라이브러리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>marvin 라이브러리를 사용하기 위해선 build.gradle에 아래의 내용을 추가해야한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">implementation</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">downgoon</span><span class="o">:</span><span class="nl">marvin:</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">5</span><span class="err">'</span>
<span class="n">implementation</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">downgoon</span><span class="o">:</span><span class="nl">MarvinPlugins:</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">5</span><span class="err">'</span>
</pre></table></code></div></div><p>S3에 업로드하는 과정에서 List<Mutipartfile>의 형태의 데이터를 이미지 리사이징하는 로직에만 포커싱하여 설명할 것이다.</Mutipartfile></p><p>s3업로드 하는 코드는 추후에 올리겠다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1">//S3UploadService</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">uploadAsList</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MultipartFile</span><span class="o">&gt;</span> <span class="n">multipartFile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"uploadAsList tx start"</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">imageList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span> <span class="c1">// 리사이징된 이미지를 저장할 공간</span>

        <span class="n">multipartFile</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">image</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getContentType</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="s">"image"</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">//이미지가 있다면 실행하고 없다면 패스</span>

            <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">createFileName</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span><span class="c1">//중복되지않게 이름을  randomUUID()를 사용해서 생성함</span>
            <span class="nc">String</span> <span class="n">fileFormat</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getContentType</span><span class="o">().</span><span class="na">substrin</span><span class="o">(</span><span class="n">image</span><span class="o">.</span><span class="na">getContentType</span><span class="o">().</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">//파일 확장자명 추출</span>

            <span class="nc">MultipartFile</span> <span class="n">resizedImage</span> <span class="o">=</span> <span class="n">resizer</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">fileFormat</span><span class="o">,</span> <span class="n">image</span><span class="o">,</span> <span class="mi">400</span><span class="o">);</span> <span class="c1">//오늘의 핵심 메서드</span>

<span class="c1">//========아래부터는 리사이징 된 후 이미지를 S3에다가 업로드하는 방법이다.=========</span>
            <span class="nc">ObjectMetadata</span> <span class="n">objectMetadata</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMetadata</span><span class="o">();</span>
            <span class="n">objectMetadata</span><span class="o">.</span><span class="na">setContentLength</span><span class="o">(</span><span class="n">resizedImage</span><span class="o">.</span><span class="na">getSize</span><span class="o">());</span> <span class="c1">//사이즈를 전달한다.</span>
            <span class="n">objectMetadata</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">resizedImage</span><span class="o">.</span><span class="na">getContentType</span><span class="o">());</span> <span class="c1">//이미지 타입을 전달한다.</span>

            <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">resizedImage</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">s3</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="k">new</span> <span class="nc">PutObjectRequest</span><span class="o">(</span><span class="n">bucket</span><span class="o">,</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">inputStream</span><span class="o">,</span> <span class="n">objectMetadata</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withCannedAcl</span><span class="o">(</span><span class="nc">CannedAccessControlList</span><span class="o">.</span><span class="na">PublicRead</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessLogicException</span><span class="o">(</span><span class="nc">ExceptionCode</span><span class="o">.</span><span class="na">FILEUPLOAD_FAILED</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">imageList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">s3</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(</span><span class="n">bucket</span><span class="o">,</span> <span class="n">fileName</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"uploadAsList tx end"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">imageList</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>위처럼 UUID를 사용하여 난수화된 이름, 파일 확장자명, 리스트에서 나온 이미지, 희망하는 너비값을 <code class="language-plaintext highlighter-rouge">resizer 메서드</code>에게 넘기면서 리사이징이 시작된다.</p><h3 id="resizer-메서드-details"><span class="mr-2">resizer 메서드 details</span><a href="#resizer-메서드-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre>
    <span class="nd">@Transactional</span> 
    <span class="kd">public</span> <span class="nc">MultipartFile</span> <span class="nf">resizer</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileFormat</span><span class="o">,</span> <span class="nc">MultipartFile</span> <span class="n">originalImage</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="nc">ImageIO</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">originalImage</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span><span class="c1">// MultipartFile -&gt; BufferedImage Convert </span>

            <span class="kt">int</span> <span class="n">originWidth</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">originHeight</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>

            <span class="c1">// origin 이미지가 400보다 작으면 패스</span>
            <span class="k">if</span><span class="o">(</span><span class="n">originWidth</span> <span class="o">&lt;</span> <span class="n">width</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">originalImage</span><span class="o">;</span>

            <span class="nc">MarvinImage</span> <span class="n">imageMarvin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MarvinImage</span><span class="o">(</span><span class="n">image</span><span class="o">);</span>

            <span class="nc">Scale</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scale</span><span class="o">();</span>
            <span class="n">scale</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
            <span class="n">scale</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"newWidth"</span><span class="o">,</span> <span class="n">width</span><span class="o">);</span>
            <span class="n">scale</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"newHeight"</span><span class="o">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">originHeight</span> <span class="o">/</span> <span class="n">originWidth</span><span class="o">);</span><span class="c1">//비율유지를 위해 높이 유지</span>
            <span class="n">scale</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">imageMarvin</span><span class="o">.</span><span class="na">clone</span><span class="o">(),</span> <span class="n">imageMarvin</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

            <span class="nc">BufferedImage</span> <span class="n">imageNoAlpha</span> <span class="o">=</span> <span class="n">imageMarvin</span><span class="o">.</span><span class="na">getBufferedImageNoAlpha</span><span class="o">();</span>
            <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="nc">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">imageNoAlpha</span><span class="o">,</span> <span class="n">fileFormat</span><span class="o">,</span> <span class="n">baos</span><span class="o">);</span>
            <span class="n">baos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomMultipartFile</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span><span class="n">fileFormat</span><span class="o">,</span><span class="n">originalImage</span><span class="o">.</span><span class="na">getContentType</span><span class="o">(),</span> <span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResponseStatusException</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="s">"파일을 줄이는데 실패했습니다."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><ol><li>marvin은 멀티쓰레드, 병렬처리방식으로 이미지를 리사이징한다. 트랜잭션 선언을 안하면 충돌이 일어나서 Input not set error 혹은 null point exception을 마주하게된다. <code class="language-plaintext highlighter-rouge">@Transactional을 선언</code>하자!<li>marvin 라이브러리에서 생성자 요구사항이 BufferedImage 형태이므로 ImageIO.read를 활용하여 BufferedImage로 변경할 필요가 있다.<li>비율을 유지하기 위해 너비값 * 원래너비/원래높이를 이용해 적용했다.<li>리사이징 작업이 끝나면 byte[]타입으로 저장되는데 이를 다시 s3에서 요구하는 MultipartFile로 변환하기 위해 MultipartFile interface를 implement 받아 구현했다.<br /> 단순 타입변환이라 생성자만 잘 만들어주면 된다.</ol><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomMultipartFile</span> <span class="kd">implements</span> <span class="nc">MultipartFile</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">originalFilename</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">contentType</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">isEmpty</span><span class="o">;</span>


    <span class="kd">public</span> <span class="nf">CustomMultipartFile</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">originalFilename</span><span class="o">,</span> <span class="nc">String</span> <span class="n">contentType</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"Name must not be null"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">originalFilename</span> <span class="o">=</span> <span class="o">(</span><span class="n">originalFilename</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">originalFilename</span> <span class="o">:</span> <span class="s">""</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">contentType</span> <span class="o">=</span> <span class="n">contentType</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="o">(</span><span class="n">content</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">content</span> <span class="o">:</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isEmpty</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getOriginalFilename</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">originalFilename</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContentType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">contentType</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBytes</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ByteArrayInputStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transferTo</span><span class="o">(</span><span class="nc">File</span> <span class="n">dest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
        <span class="nc">FileCopyUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">content</span><span class="o">,</span> <span class="n">dest</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="결과"><span class="mr-2">결과</span><a href="#결과" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="https://github.com/mskim0425/mskim0425.github.io/blob/main/images/java/%EC%9D%B4%EB%AF%B8%EC%A7%80%20%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95.png?raw=https://raw.githubusercontent.com/cotes2020/chirpy-images/maintrue" width="800" data-proofer-ignore></p><p>눈에 띄게 줄어든 용량과 이미지가 꺠지지 않음을 확인 할 수 있었다.</p><p>또한 원본 이미지들을 다운로드 후, 다시 업로드는 하는 형태로 s3 프리티어 저장공간도 45%정도 확보하는 결과를 도출해 냈다.<br /> <img data-src="https://github.com/mskim0425/mskim0425.github.io/blob/main/images/java/123123.png?raw=https://raw.githubusercontent.com/cotes2020/chirpy-images/maintrue" data-proofer-ignore></p><h2 id="출처"><span class="mr-2">출처</span><a href="#출처" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://docs.oracle.com/javase/7/docs/api/javax/imageio/ImageIO.html">ImageIo 공식문서</a><br /> <a href="https://marvinproject.sourceforge.net/en/tutorials.html">Maven repo</a> <a href="https://www.baeldung.com/java-resize-image">Baeldung</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spring/'>Spring</a>, <a href='/categories/troubleshooting/'>troubleshooting</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a> <a href="/tags/troubleshooting/" class="post-tag no-text-decoration" >troubleshooting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Marvin+%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EB%A5%BC+%ED%99%9C%EC%9A%A9%ED%95%9C+S3%EC%97%90+%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95%EB%90%9C+%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%85%EB%A1%9C%EB%93%9C+-+SoThoughtful%3B&url=https%3A%2F%2Fmskim0425.github.io%2Fposts%2Fimage-resizing%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Marvin+%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EB%A5%BC+%ED%99%9C%EC%9A%A9%ED%95%9C+S3%EC%97%90+%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95%EB%90%9C+%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%85%EB%A1%9C%EB%93%9C+-+SoThoughtful%3B&u=https%3A%2F%2Fmskim0425.github.io%2Fposts%2Fimage-resizing%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmskim0425.github.io%2Fposts%2Fimage-resizing%2F&text=Marvin+%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EB%A5%BC+%ED%99%9C%EC%9A%A9%ED%95%9C+S3%EC%97%90+%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95%EB%90%9C+%EC%9D%B4%EB%AF%B8%EC%A7%80+%EC%97%85%EB%A1%9C%EB%93%9C+-+SoThoughtful%3B" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fmskim0425.github.io%2Fposts%2Fimage-resizing%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div><script src="https://utteranc.es/client.js" repo="mskim0425/mskim0425.github.io" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/java-basic-2/">Basic Confusing Questions Ⅱ 🤷‍♂️ (17개)</a><li><a href="/posts/query_series1/">mysql 쿼리 기능</a><li><a href="/posts/about_index/">INDEX에 관하여</a><li><a href="/posts/useful_gems/">Ruby GEM 시리즈</a><li><a href="/posts/debug_rails/">Rails 디버깅</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs/">cs</a> <a class="post-tag" href="/tags/design-pattern/">design pattern</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/rails/">rails</a> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/questions/">questions</a> <a class="post-tag" href="/tags/ruby-on-rails/">ruby-on-rails</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/annotation/"><div class="card-body"> <em class="small" data-ts="1664260917" data-df="ll" > Sep 27, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Spring] Annotation</h3><div class="text-muted small"><p> Spring Annotation Annotation이란? 소스코드에 제공되는 메타데이터이다. 앱이 처리하는 데이터가 아닌 컴파일 과정,실행 과정에서 코드를 어떻게 처리해야 하는지 알려주는 용도로 사용된다. 어노테이션에는 크게 2가지가 있다. built-in 어노테이션 Java 코드에 적용되는 어노테이션 @Override, @Dep...</p></div></div></a></div><div class="card"> <a href="/posts/spring-1/"><div class="card-body"> <em class="small" data-ts="1664505717" data-df="ll" > Sep 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Spring] @Component와 @Configuration</h3><div class="text-muted small"><p> @Configuration의 선언부를 보면 @Component가 정의되어 있다. @Component는 개발자가 작성한 클래스를 Bean으로 등록하고자 할 때 사용한다. 개발자가 직접 제어 가능 : @Component 개발자가 직접 제어 불가능 : @Configuration, @Bean {. :prompt-tip} @Component 개...</p></div></div></a></div><div class="card"> <a href="/posts/Aop/"><div class="card-body"> <em class="small" data-ts="1666759977" data-df="ll" > Oct 26, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AOP</h3><div class="text-muted small"><p> “AOP? 횡단관심사?” 사용하게 된 계기 토이 프로젝트에서 여러명이서 각기 다른 컨트롤러를 개발하다보니 컨트롤러 단에서 중복되는 불필요한 코드가 많아졌다. 또한, 컨트롤러에서 핵심로직에 대한 가독성이 떨어지는 결과가 나타났다. 　 서로 다른 컨트롤러 끼리 묶음 　 위와 같이 서로 다른 컨트롤들에 공통적으로 필요한 기능들을 횡단관심사...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/note_algo/" class="btn btn-outline-primary" prompt="Older"><p>Algorithm just for memo</p></a> <a href="/posts/java-version/" class="btn btn-outline-primary" prompt="Newer"><p>Java 8-17 정리</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cs/">cs</a> <a class="post-tag" href="/tags/design-pattern/">design pattern</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/rails/">rails</a> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/questions/">questions</a> <a class="post-tag" href="/tags/ruby-on-rails/">ruby-on-rails</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/msKim0425">Minsub Kim</a>.</p></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
